{# 1. 配置逻辑 #}
{% set repo_base = "https://github.com/MontageWiki/wiki/wiki" %}
{% set page_name = page.file.src_uri | replace("index.md", "Home") | replace(".md", "") %}

{# 弹出框内的快速链接定义 #}
{% set quick_links = [
    { "title": "百科语法指南", "url": repo_base ~ "/百科语法指南" },
    { "title": "GitHub 帮助指南", "url": repo_base ~ "/GitHub-帮助指南" },
    { "title": "贡献指南", "url": repo_base ~ "/贡献指南" }
] %}

<div class="md-content__articles custom-actions-container">
  
  {# 编辑按钮与浮层：使用 details 模拟，完全移除背景包裹 #}
  <details class="action-item-details" data-search-ignore>
    <summary class="md-content__button md-icon" title="贡献与编辑" aria-haspopup="true">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg>
    </summary>

    {# 弹出层：使用 aside 标签进一步隔离 SEO #}
    <aside class="actions-popover" aria-label="贡献引导">
      {# 水滴/箭头结构 #}
      <div class="popover-arrow"></div>
      
      <div class="popover-inner">
        <div class="popover-header">
          <strong>参与百科贡献</strong>
          <p>一本众创、共建、同享的字幕百科</p>
        </div>
        
        <a href="{{ repo_base }}/{{ page_name }}/_edit" class="gh-btn-primary">
          使用 GitHub 账号编辑
        </a>

        <nav class="popover-links">
          {% for link in quick_links %}
            <a href="{{ link.url }}">{{ link.title }}</a>
          {% endfor %}
        </nav>
      </div>
    </aside>
  </details>

  {# 查看历史：保持原有的极简风格 #}
  <a href="{{ repo_base }}/{{ page_name }}/_history" class="md-content__button md-icon" title="查看编辑历史">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"></path></svg>
  </a>
</div>

<style>
/* 1. 基础布局：移除任何背景色，保持图标纯净 */
.custom-actions-container {
  float: right;
  display: flex;
  gap: 12px;
  margin-top: 0.4rem;
  position: relative;
  z-index: 100;
}

.action-item-details { position: relative; }
.action-item-details summary { list-style: none; outline: none; }
.action-item-details summary::-webkit-details-marker { display: none; }

/* 2. 弹出层设计：阴影与深度感 */
.actions-popover {
  position: absolute;
  top: calc(100% + 12px);
  right: -10px;
  width: 240px;
  background: var(--md-default-bg-color);
  border-radius: 8px;
  /* 强阴影效果 [要求二] */
  box-shadow: 0 8px 24px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);
  border: 1px solid var(--md-divider-color);
  animation: slideUp 0.2s ease-out;
}

/* 3. 水滴/箭头结构 [要求二] */
.popover-arrow {
  position: absolute;
  top: -6px;
  right: 18px;
  width: 12px;
  height: 12px;
  background: var(--md-default-bg-color);
  border-left: 1px solid var(--md-divider-color);
  border-top: 1px solid var(--md-divider-color);
  transform: rotate(45deg);
}

/* 弹出内容隔离设计 */
.popover-inner { padding: 16px; }
.popover-header strong { display: block; font-size: 0.8rem; margin-bottom: 4px; }
.popover-header p { 
  font-size: 0.7rem; 
  color: var(--md-default-fg-color--light); 
  margin: 0 0 12px 0;
  line-height: 1.4;
}

/* 4. GitHub 风格按钮 */
.gh-btn-primary {
  display: block;
  background-color: #1f883d;
  color: #fff !important;
  text-align: center;
  padding: 8px;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
  text-decoration: none;
  margin-bottom: 12px;
}

/* 5. 底部链接区域：SEO 隔离导航 */
.popover-links {
  border-top: 1px solid var(--md-divider-color);
  padding-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.popover-links a {
  font-size: 0.7rem;
  color: var(--md-typeset-a-color);
  text-decoration: none;
}
.popover-links a:hover { text-decoration: underline; }

/* 动画效果 */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 手机端点击外部关闭支持 */
.action-item-details[open] summary::before {
  content: "";
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  z-index: -1;
}
</style>
