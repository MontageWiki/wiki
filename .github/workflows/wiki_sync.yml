name: "Publish: MontageSubs Encyclopedia"

on:
  workflow_dispatch:
  gollum:
  schedule:
    - cron: '11 14 * * *' 
    
permissions:
  contents: write

jobs:
  sync-history:
    name: Replay Wiki History and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4
        with:
          ref: infra
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            mkdocs-material \
            jieba \
            mkdocs-git-revision-date-localized-plugin \
            mkdocs-minify-plugin \
            mkdocs-awesome-pages-plugin

      - name: Replay Wiki History
        id: replay
        run: |
          CONFIG_DIR="config"
          COMMIT_FILE="$CONFIG_DIR/wiki_last_commit"
          mkdir -p "$CONFIG_DIR"
          
          if [ -f "$COMMIT_FILE" ]; then
            LAST_SYNC_SHA=$(cat "$COMMIT_FILE")
          else
            LAST_SYNC_SHA=""
          fi
          
          git clone https://github.com/MontageSubs/wiki.wiki.git wiki_git
          cd wiki_git
          
          if [ -z "$LAST_SYNC_SHA" ]; then
            COMMITS=$(git rev-list --reverse HEAD)
          else
            COMMITS=$(git rev-list --reverse $LAST_SYNC_SHA..HEAD)
          fi
          
          if [ -z "$COMMITS" ]; then
            echo "No new commits to replay."
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          for SHA in $COMMITS; do
            echo "Processing wiki commit: $SHA"
            AUTHOR_NAME=$(git show -s --format='%an' $SHA)
            AUTHOR_EMAIL=$(git show -s --format='%ae' $SHA)
            AUTHOR_DATE=$(git show -s --format='%ad' $SHA)
            COMMIT_MSG=$(git show -s --format='%s' $SHA)
            
            git checkout $SHA
            cd ..
            
            mkdir -p docs
            find docs -mindepth 1 -not -path 'docs/site*' -delete
            cp -r wiki_git/* docs/
            rm -rf docs/.git

            find docs -name "_*.md" -delete
            find docs -name "*.md" -exec sed -i -E 's/\[\[([^]|]+)\|([^]]+)\]\]/[\2](\1.md)/g' {} +
            find docs -name "*.md" -exec sed -i -E 's/\[\[([^]|]+)\]\]/[\1](\1.md)/g' {} +
            
            if [ -f docs/Home.md ]; then mv docs/Home.md docs/index.md; fi
            echo "$SHA" > "$COMMIT_FILE"
            git add docs "$COMMIT_FILE"
            
            export GIT_AUTHOR_NAME="$AUTHOR_NAME"
            export GIT_AUTHOR_EMAIL="$AUTHOR_EMAIL"
            export GIT_AUTHOR_DATE="$AUTHOR_DATE"
            export GIT_COMMITTER_NAME="$AUTHOR_NAME"
            export GIT_COMMITTER_EMAIL="$AUTHOR_EMAIL"
            export GIT_COMMITTER_DATE="$AUTHOR_DATE"
            
            git commit --allow-empty \
              -m "wiki: $COMMIT_MSG" \
              -m "Original Wiki Hash: $SHA"
            
            unset GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL GIT_AUTHOR_DATE
            unset GIT_COMMITTER_NAME GIT_COMMITTER_EMAIL GIT_COMMITTER_DATE
            cd wiki_git
          done
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Push Replayed History
        if: steps.replay.outputs.changed == 'true'
        run: |
          git push origin infra

      - name: Deploy to GitHub Pages
        if: steps.replay.outputs.changed == 'true'
        run: |
          python -m mkdocs gh-deploy --force --clean
